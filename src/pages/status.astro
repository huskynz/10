---
// StatusCheck.astro
const API_URL = import.meta.env.PUBLIC_API_URL || 'https://www.husky.nz';

// Service endpoints to check
const SERVICES = [
  { name: 'Main System', url: `${API_URL}/api/status`, type: 'braille' },
  { name: 'Netlify', url: 'https://www.netlify.com/', type: 'http' },
  { name: 'GitHub', url: 'https://www.githubstatus.com/api/v2/status.json', type: 'http' },
  { name: 'Cloudflare', url: 'https://www.cloudflarestatus.com/api/v2/status.json', type: 'http' }
];

// Expected patterns for braille check
const START_PATTERN = "⢦⠱⢌⠦⠱⡌⠦⡱⠌⢦⠱⢌⠦⠱";
const END_PATTERN = "⢡⠘⡠⠑⡂";

async function checkService(service) {
  try {
    const response = await fetch(service.url, {
      method: 'GET',
      headers: { 'Accept': 'application/json' }
    });

    if (!response.ok) return false;

    if (service.type === 'braille') {
      const data = await response.json();
      if (Array.isArray(data) && data.length > 0) {
        const firstItem = data[0];
        return firstItem.startsWith(START_PATTERN) && firstItem.endsWith(END_PATTERN);
      }
      return false;
    }

    return true;
  } catch (error) {
    console.error(`${service.name} check failed:`, error);
    return false;
  }
}

// Check all services
const serviceStatuses = await Promise.all(
  SERVICES.map(async service => ({
    ...service,
    isUp: await checkService(service)
  }))
);

const workingServices = serviceStatuses.filter(s => s.isUp).length;
const status = workingServices === SERVICES.length ? 'up' : 
               workingServices > 0 ? 'partial' : 'down';
---

<div class="status-container">
  <div class={`status status-${status}`}>
    <span class="status-dot"></span>
    {status === 'up' && 'All Systems Operational'}
    {status === 'partial' && 'Partial System Outage'}
    {status === 'down' && 'System is Down'}
  </div>

  <div class="services-list">
    {serviceStatuses.map(service => (
      <div class={`service-item ${service.isUp ? 'up' : 'down'}`}>
        <span class="status-dot"></span>
        {service.name}
      </div>
    ))}
  </div>
</div>

<style>
  .status-container {
    padding: 1rem;
    text-align: center;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .status {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: 9999px;
    font-weight: 500;
  }

  .status-up {
    background-color: #ecfdf5;
    color: #065f46;
  }

  .status-partial {
    background-color: #fffbeb;
    color: #92400e;
  }

  .status-down {
    background-color: #fef2f2;
    color: #991b1b;
  }

  .services-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-top: 1rem;
  }

  .service-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem;
    border-radius: 0.375rem;
    background-color: #f9fafb;
  }

  .service-item.up .status-dot {
    background-color: #059669;
  }

  .service-item.down .status-dot {
    background-color: #dc2626;
  }

  .status-dot {
    width: 0.75rem;
    height: 0.75rem;
    border-radius: 50%;
  }

  .status-up .status-dot {
    background-color: #059669;
  }

  .status-partial .status-dot {
    background-color: #f59e0b;
  }

  .status-down .status-dot {
    background-color: #dc2626;
  }
</style>